<!-- index/index.wxml -->
<view class="container">
    <!-- 状态卡片 -->
    <view class="status-card {{isFasting ? 'fasting' : 'eating'}}">
        <view class="status-content">
            <view class="status-text {{isFasting ? 'fasting-text' : 'eating-text'}}">
                {{isFasting ? '断食中' : '可进食'}}
            </view>
            <view class="status-info">
                <view class="timer">
                    {{fastingMode === '168' ? '16:8' : '20:4'}} 模式
                </view>
                <view class="time-range">
                    <!-- 进食窗口: {{eatingStart}} - {{eatingEnd}} -->
                </view>
            </view>
        </view>
    </view>

    <!-- 圆形时间轴 -->
    <!-- <view class="circle-timeline-container">
        <view class="circle-bg">
            <view class="circle-fasting"></view>
            <view class="circle-eating" 
                  style="transform: rotate({{eatingStartAngle}}deg);clip-path: polygon(50% 50%, 50% 0%, {{getEatingEndPoint()}});"></view>
        </view>
        <view class="time-pointer" 
              style="transform: translate(-50%, -100%) rotate({{currentTimeAngle}}deg)"></view>
        <view class="circle-labels">
            <block wx:for="{{[0, 6, 12, 18]}}" wx:key="index">
                <view class="circle-label" 
                      style="transform: rotate({{item * 15}}deg) translate({{circleRadius - 30}}rpx) rotate(-{{item * 15}}deg)">
                    <text>{{item}}:00</text>
                </view>
            </block>
        </view>
        <view class="circle-now" 
              style="transform: rotate({{currentTimeAngle}}deg) translate({{circleRadius - 20}}rpx) rotate(-{{currentTimeAngle}}deg)">
            <view class="now-indicator"></view>
            <view class="now-label">{{currentHour}}:{{currentMinute}}</view>
        </view>
        <view class="circle-center"></view>
    </view> -->

    <!-- 进度条区域 -->
    <view class="progress-section">
        <view class="progress-header">
            <text class="section-title">{{isFasting ? '断食进度' : '进食进度'}}</text>
            <text class="progress-percent">{{progress}}%</text>
        </view>
        <view class="progress-container">
            <view class="progress-bar">
                <view class="progress-fill" style="width: {{progress}}%"></view>
            </view>
            <view class="progress-labels">
                <text>{{isFasting ? '断食开始' : '进食开始'}}</text>
                <text>{{remainingTime}}小时后结束</text>
            </view>
            <view class="progress-info">
                <text>当前: {{currentHour}}:{{currentMinute}}</text>
                <text>{{isFasting ? '下次进食' : '下次断食'}}: {{isFasting ? eatingStart : eatingEnd}}</text>
            </view>
        </view>
    </view>

    <!-- 今日进餐记录 -->
    <view class="meal-section">
        <view class="section-header">
            <text class="section-title">今日进餐记录</text>
            <text class="meal-count">已记录 {{todayMeals.length}} 次</text>
        </view>
        <view class="meal-scroll-container">
            <view class="meal-content">
                <view wx:if="{{todayMeals.length === 0}}" class="empty-tip">
                    <image src="/images/empty.png" class="empty-icon"></image>
                    <text>今日尚未记录进餐</text>
                </view>
                <view wx:else class="meal-records">
                    <block wx:for="{{todayMeals}}" wx:key="item">
                        <view class="meal-item">
                            <view class="meal-time">{{item}}</view>
                            <view class="meal-type">{{getMealType(index)}}</view>
                            <view class="meal-actions">
                                <view class="edit-icon" bindtap="showTimePicker" data-index="{{index}}">✎</view>
                                <view class="delete-icon" bindtap="deleteMeal" data-index="{{index}}">✕</view>
                            </view>
                        </view>
                    </block>
                </view>
            </view>
        </view>
    </view>

    <!-- 时间选择器弹窗 -->
    <view class="time-picker-modal" wx:if="{{showPicker}}">
        <view class="picker-container">
            <view class="picker-header">
                <text class="picker-title">编辑进餐时间</text>
            </view>
            <picker mode="time" value="{{selectedTime}}" start="00:00" end="23:59" bindchange="timeChange">
                <view class="picker-display">
                    <text class="picker-time">{{selectedTime}}</text>
                    <text class="picker-hint">点击选择时间</text>
                </view>
            </picker>
            <view class="picker-buttons">
                <button class="picker-btn cancel" bindtap="hidePicker">取消</button>
                <button class="picker-btn confirm" bindtap="updateMealTime">确定</button>
            </view>
        </view>
    </view>

    <!-- 浮动按钮组 -->
    <view class="floating-actions">
        <button class="floating-button photo" bindtap="takeFoodPhoto">
            <view class="button-icon">📷</view>
            <text>拍热量</text>
        </button>
        <button class="floating-button record" bindtap="recordMealNow">
            <view class="button-icon">+</view>
            <text>记录进餐</text>
        </button>
    </view>

    <!-- 食物识别结果弹窗 -->
    <view class="food-result-modal" wx:if="{{showFoodResult}}">
        <view class="result-container">
            <view class="result-header">
                <text class="result-title">食物识别结果</text>
                <text class="close-icon" bindtap="closeFoodResult">×</text>
            </view>
            <view class="recognition-results">
                <view class="result-item" wx:for="{{recognizedFoods}}" wx:key="index" 
                      bindtap="selectFood" data-index="{{index}}" 
                      class="{{selectedFoodIndex == index ? 'result-item-selected' : ''}}">
                    <view class="result-item-header">
                        <text class="food-name">{{item.name}}</text>
                        <text class="recognition-probability">匹配度 {{item.probability}}%</text>
                    </view>
                    <text class="food-calories">{{item.calories}}</text>
                </view>
            </view>
            <view class="selected-food-detail">
                <view class="food-image-container">
                    <image src="{{takenImagePath}}" mode="widthFix" binderror="onFoodImageError"></image>
                </view>
                <view class="food-info">
                    <text class="food-name">{{recognizedFood.name}}</text>
                    <text class="food-calories">{{recognizedFood.calories}}</text>
                    <view class="food-nutrition">
                        <text>识别可信度：{{recognizedFood.probability}}%</text>
                    </view>
                </view>
                <view class="food-description" wx:if="{{recognizedFood.description}}">
                    <text class="advice-title">食物简介</text>
                    <text class="advice-content">{{recognizedFood.description}}</text>
                </view>
                <view class="diet-advice">
                    <text class="advice-title">饮食建议</text>
                    <text class="advice-content">{{dietAdvice}}</text>
                </view>
            </view>
            <view class="result-buttons">
                <button class="result-btn cancel" bindtap="closeFoodResult">取消</button>
                <button class="result-btn confirm" bindtap="saveFoodRecord">记录用餐</button>
            </view>
        </view>
    </view>

    <!-- 操作反馈提示 -->
    <view class="action-toast" wx:if="{{showMealActionToast}}">
        <text>{{mealActionFeedback}}</text>
    </view>
</view>